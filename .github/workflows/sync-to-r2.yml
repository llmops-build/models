name: PROD | Sync to R2

on:
  push:
    branches: ["main"]
    paths:
      - "pricing/**"
      - "general/**"
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

jobs:
  validate:
    name: Validate JSON Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "  VALIDATING JSON CONFIGS"
          echo "════════════════════════════════════════════════════════════"

          ERRORS=0

          for file in pricing/*.json general/*.json; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "❌ Invalid JSON: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "✅ $file"
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "❌ Validation failed with $ERRORS error(s)"
            exit 1
          fi

          echo ""
          echo "✅ All JSON files are valid!"

  upload-to-r2:
    name: Upload to R2
    needs: validate
    runs-on: ubuntu-latest
    environment: CF_ENVs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync JSON files to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          aws s3 sync . "s3://${{ vars.R2_BUCKET_NAME }}/" \
            --endpoint-url "https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
            --exclude "*" \
            --include "pricing/*.json" \
            --include "general/*.json" \
            --content-type "application/json" \
            --cache-control "no-cache"

      - name: Verify upload
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          echo "Listing R2 bucket contents..."
          aws s3 ls "s3://${{ vars.R2_BUCKET_NAME }}/pricing/" \
            --endpoint-url "https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com" | head -5
          echo "..."
          echo "✅ Upload verified"

  trigger-deployments:
    name: Trigger Deployments
    needs: upload-to-r2
    runs-on: ubuntu-latest
    environment: CF_ENVs
    steps:
      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: portkey-ai
          repositories: gateway-enterprise-node

      - name: Trigger Gateway workflow
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/portkey-ai/gateway-enterprise-node/actions/workflows/sync-and-deploy.yml/dispatches \
            -d '{"ref":"main","inputs":{"source_branch":"main"}}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 204 ]; then
            echo "✅ Successfully triggered gateway sync-and-deploy workflow (production)"
          else
            echo "❌ Failed to trigger gateway workflow. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
